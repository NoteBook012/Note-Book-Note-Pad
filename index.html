<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
    <!-- NEW: SEO Meta Tags -->
    <title>Note P@d - Modern Online Notepad, Whiteboard & To-Do List</title>
    <meta name="description" content="Note P@d is a free, fast, and secure online application featuring a modern notepad, a digital whiteboard for drawing, and a to-do list manager. Your data is saved locally. Works offline."/>
    <meta name="keywords" content="online notepad, notepad, text editor, whiteboard, online drawing tool, to-do list, checklist, pwa, secure notepad, offline notes, bishal mishra"/>
    <meta name="author" content="Bishal Mishra">
    <meta name="robots" content="index, follow">
    <!-- NEW: Make sure to replace this with your actual website URL! -->
    <link rel="canonical" href="https://your-domain-here.com/">

    <!-- NEW: Open Graph / Social Media Tags -->
    <meta property="og:title" content="Note P@d - Modern Online Notepad, Whiteboard & To-Do List" />
    <meta property="og:description" content="A free, secure online tool with a notepad, whiteboard, and to-do list. Works offline, no sign-up required for basic use." />
    <meta property="og:image" content="https://i.imgur.com/kR1k1jU.png" />
    <meta property="og:url" content="https://your-domain-here.com/" />
    <meta property="og:type" content="website" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
   
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/kR1k1jU.png">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
   
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- NEW: JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Note P@d",
      "applicationCategory": "ProductivityApplication",
      "operatingSystem": "All (Web-based)",
      "offers": {
        "@type": "Offer",
        "price": "0"
      },
      "description": "A free, fast, and secure online application featuring a modern notepad, a digital whiteboard for drawing, and a to-do list manager.",
      "author": {
        "@type": "Person",
        "name": "Bishal Mishra"
      }
    }
    </script>

    <!-- STYLES -->
    <style>
        :root {
            --bg-light: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            --text-light: #333;
            --card-light: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.08);

            --bg-dark: linear-gradient(120deg, #2b2b2b 0%, #1e1e1e 100%);
            --text-dark: #e0e0e0;
            --card-dark: #2c2c2c;
            --shadow-dark: rgba(0, 0, 0, 0.25);
           
            --primary: #8c53ff;
            --primary-dark: #7042cc;
            --radius: 12px;
        }

        html { height: 100%; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--text-light); line-height: 1.6; transition: background 0.3s, color 0.3s; display: flex; flex-direction: column; min-height: 100vh; }
        body.dark { background: var(--bg-dark); color: var(--text-dark); }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* NEW: Changed container to main for semantic HTML */
        main.container { width: 95%; max-width: 1200px; margin: 20px auto; flex-grow: 1; }

        header, footer { background: var(--primary); color: white; padding: 15px 20px; text-align: center; box-shadow: 0 4px 15px var(--shadow-light); z-index: 10; }
        body.dark header, body.dark footer { box-shadow: 0 4px 15px var(--shadow-dark); }
        footer { margin-top: auto; }
        footer a { color: #fff; font-weight: 600; text-decoration: none; transition: opacity 0.2s; }
        footer a:hover { opacity: 0.8; }

        #menu-bar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: var(--card-light); padding: 15px; border-radius: var(--radius); margin: 20px 0; box-shadow: 0 4px 15px var(--shadow-light); }
        #menu-bar button, #menu-bar select { padding: 8px 15px; border-radius: var(--radius); border: none; cursor: pointer; background-color: #f0f0f0; color: #333; font-weight: 600; transition: background-color 0.2s, transform 0.2s; }
        #menu-bar button:hover, #menu-bar select:hover { background-color: #e0e0e0; transform: translateY(-2px); }
        body.dark #menu-bar { background: #252525; box-shadow: 0 4px 15px var(--shadow-dark); }
        body.dark #menu-bar button, body.dark #menu-bar select { background-color: var(--card-dark); color: var(--text-dark); }
        
        /* NEW: Active mode button style */
        .mode-switcher button.active-mode { background-color: var(--primary); color: white; }
        body.dark .mode-switcher button.active-mode { background-color: var(--primary-dark); }
        .mode-switcher { border-left: 2px solid #ddd; padding-left: 10px; margin-left: 10px; display:flex; gap: 10px; }
        body.dark .mode-switcher { border-left-color: #555; }


        #editor, #notes, .info-section, #whiteboard-container { background: var(--card-light); padding: 25px; border-radius: var(--radius); box-shadow: 0 4px 15px var(--shadow-light); margin-bottom: 25px; }
        body.dark #editor, body.dark #notes, body.dark .info-section, body.dark #whiteboard-container { background: var(--card-dark); box-shadow: 0 4px 15px var(--shadow-dark); }
       
        #editor textarea, #editor input[type="text"] { width: 100%; font-size: 16px; padding: 12px; border-radius: var(--radius); border: 1px solid #e0e0e0; background: var(--bg-light); color: var(--text-light); resize: vertical; transition: border-color 0.3s, box-shadow 0.3s; }
        #editor textarea:focus, #editor input[type="text"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(140, 83, 255, 0.2); }
        #editor input[type="text"] { margin-bottom: 15px; font-size: 20px; font-weight: 600; }
        body.dark #editor textarea, body.dark #editor input[type="text"] { border-color: #444; background: #333; }
        
        /* NEW: Styles for Word/Char Count */
        #editor-stats { display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #888; }
        body.dark #editor-stats { color: #aaa; }

        /* NEW: Whiteboard Styles */
        #whiteboard-canvas { border: 2px solid #eee; border-radius: var(--radius); cursor: crosshair; touch-action: none; /* For mobile */ }
        body.dark #whiteboard-canvas { border-color: #444; }
        #whiteboard-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-top: 15px; }
        #whiteboard-toolbar label { font-weight: 600; }
        #whiteboard-toolbar input[type="color"] { width: 40px; height: 40px; border: none; padding: 0; cursor: pointer; background: none; border-radius: 50%; }
        #whiteboard-toolbar input[type="range"] { cursor: pointer; }
        #whiteboard-toolbar button { padding: 8px 15px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background: #f0f0f0; font-weight: 500; }
        #whiteboard-toolbar button.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* NEW: To-Do List Styles */
        #todo-list-container { min-height: 200px; padding: 10px; border-radius: var(--radius); border: 1px solid #e0e0e0; }
        body.dark #todo-list-container { border-color: #444; }
        .todo-item { display: flex; align-items: center; gap: 12px; font-size: 16px; padding: 8px 4px; border-bottom: 1px solid #f0f0f0; }
        body.dark .todo-item { border-bottom-color: #3a3a3a; }
        .todo-item:last-child { border-bottom: none; }
        .todo-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); }
        .todo-item .todo-text { flex-grow: 1; outline: none; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #999; }
        #add-todo-btn { margin-top: 15px; }

        .note { border-radius: var(--radius); padding: 20px; margin-bottom: 15px; border: 1px solid #e7e7e7; transition: box-shadow 0.3s, transform 0.3s; }
        .note:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--shadow-light); }
        body.dark .note { border-color: #444; }
        body.dark .note:hover { box-shadow: 0 6px 20px var(--shadow-dark); }
        .note.pinned { border-left: 5px solid gold; }
        .note h4 { margin-bottom: 5px; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .note p { margin: 10px 0; word-break: break-word; } /* Allow long words to break */
        .note small { color: #888; }
        body.dark .note small { color: #aaa; }
        .note-actions button { margin-right: 8px; margin-top: 10px; padding: 6px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background: #f0f0f0; font-weight: 500; }
        body.dark .note-actions button { background: #3e3e3e; color: var(--text-dark); border-color: #555; }

        h3 { font-size: 24px; margin-bottom: 20px; color: var(--primary); text-align: center; }
        .info-section ul { list-style: none; padding-left: 0; }
        .info-section ul li { padding-left: 30px; position: relative; margin-bottom: 12px; }
        .info-section ul li::before { content: '\f058'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--primary); position: absolute; left: 0; top: 2px; font-size: 18px; }

        .user-info { position: fixed; top: 20px; right: 20px; background: var(--card-light); padding: 10px 16px; border-radius: 50px; box-shadow: 0 4px 15px var(--shadow-light); font-size: 14px; display: none; align-items: center; gap: 12px; z-index: 999; }
        body.dark .user-info { background: var(--card-dark); box-shadow: 0 4px 15px var(--shadow-dark); }
        
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Other existing styles... (modal, about-dev, etc.) */
        .about-dev { display: flex; align-items: center; gap: 25px; } .about-dev img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); box-shadow: 0 4px 15px var(--shadow-light); } body.dark .about-dev img { box-shadow: 0 4px 15px var(--shadow-dark); } .about-dev a { color: var(--primary); font-weight: 600; text-decoration: none; } .about-dev a:hover { text-decoration: underline; } .modal, .welcome-popup { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); z-index: 1001; } .modal-content, .welcome-content { font-family: 'Inter', sans-serif; background: var(--card-light); color: var(--text-light); padding: 32px; border-radius: var(--radius); text-align: center; max-width: 380px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); animation: fadeIn 0.5s ease; border: 1px solid rgba(255, 255, 255, 0.1); } body.dark .modal-content, body.dark .welcome-content { background: var(--card-dark); color: var(--text-dark); } .modal-content h2, .welcome-content h2 { margin-bottom: 20px; } .modal-content input { width: 100%; padding: 12px 14px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: var(--radius); font-size: 16px; background: var(--bg-light); color: var(--text-light); } body.dark .modal-content input { border-color: #555; background: #333; } .modal-content button, .welcome-content button { background: var(--primary); color: white; padding: 12px 24px; border: none; border-radius: var(--radius); font-size: 16px; margin-top: 16px; cursor: pointer; transition: background 0.3s ease; width: 100%; } .modal-content button:hover, .welcome-content button:hover { background: var(--primary-dark); } .modal-content a { color: var(--primary); text-decoration: none; font-size: 13px; display: block; margin-top: 12px; } .user-info img { height: 32px; width: 32px; border-radius: 50%; } .user-info span { font-weight: 600; } .user-info button { padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 50px; font-size: 13px; cursor: pointer; transition: background 0.3s; } .user-info button:hover { background: #b91c1c; } #goToTopBtn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: var(--primary); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; display: none; z-index: 1000; box-shadow: 0 4px 12px var(--shadow-light); transition: background-color 0.2s, transform 0.2s; } #goToTopBtn:hover { background-color: var(--primary-dark); transform: scale(1.1); } body.dark #goToTopBtn { box-shadow: 0 4px 12px var(--shadow-dark); } #find-replace-dialog { position: fixed; top: 150px; left: 50%; transform: translateX(-50%); background: var(--card-light); padding: 20px; border-radius: var(--radius); box-shadow: 0 8px 25px var(--shadow-light); z-index: 1002; display: flex; gap: 10px; align-items: center; } body.dark #find-replace-dialog { background: var(--card-dark); box-shadow: 0 8px 25px var(--shadow-dark); } #find-replace-dialog input { padding: 8px; border-radius: 8px; border: 1px solid #ccc; } #find-replace-dialog button { padding: 8px 12px; } #find-replace-dialog .close-btn { position: absolute; top: 5px; right: 10px; background: transparent; border: none; font-size: 20px; cursor: pointer; } .confetti { font-size: 48px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: pop 1s ease-out; pointer-events: none; z-index: 2000; } @keyframes pop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 60% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
        @media (max-width: 768px) { .about-dev { flex-direction: column; text-align: center; } .user-info { top: 10px; right: 10px; } #find-replace-dialog { flex-direction: column; width: 90%; top: 100px; } .mode-switcher { border-left: none; padding-left: 0; margin-left: 0; border-top: 1px solid #ddd; padding-top: 10px; width: 100%; justify-content: center;} body.dark .mode-switcher { border-top-color: #555;} }
    </style>
</head>
<body>

<div id="userInfo" class="user-info">
    <img id="userPic" src="" alt="Profile" />
    <span id="userNameDisplay"></span>
    <button id="logoutBtn">Logout</button>
</div>

<header>
    <h1>📝 NOTE_<span style="color:#ffc107">P@D</span></h1>
    <p style="margin-top: 5px; font-weight: 300; opacity: 0.9;">Notepad, Whiteboard, and To-Do List All-in-One</p>
</header>

<!-- NEW: Using main tag for better SEO and accessibility -->
<main class="container">
    <div id="menu-bar">
        <button onclick="newDoc()">📝 New</button>
        <button onclick="saveNote()">💾 Save</button>
        <button onclick="undo()" title="Undo (Ctrl+Z)">↩️ Undo</button>
        <button onclick="redo()" title="Redo (Ctrl+Y)">↪️ Redo</button>
        <button onclick="cutText()">✂️ Cut</button>
        <button onclick="showFindReplace()">🔍 Find/Replace</button>
        <button id="installBtn" class="hidden">💻 Install App</button>
        <select id="font-family" onchange="changeFont()" title="Change Font Family">
            <option value="Poppins">Poppins</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Georgia">Georgia</option>
        </select>
        <select id="font-size" onchange="changeFontSize()" title="Change Font Size">
            <option value="16px" selected>16px</option>
            <option value="18px">18px</option>
            <option value="20px">20px</option>
        </select>
        <button onclick="toggleDark()" title="Toggle Dark/Light Mode">🌗</button>

        <!-- NEW: Mode Switcher -->
        <div class="mode-switcher">
            <button id="mode-notepad" onclick="switchMode('notepad')" class="active-mode">Notepad</button>
            <button id="mode-whiteboard" onclick="switchMode('whiteboard')">Whiteboard</button>
            <button id="mode-todo" onclick="switchMode('todo')">To-Do List</button>
        </div>
    </div>

    <!-- Notepad Editor (Default) -->
    <div id="editor">
        <input type="text" id="note-title" placeholder="Your Note Title..." />
        <textarea id="note-text" placeholder="Start typing... your work is saved automatically." rows="10"></textarea>
        
        <!-- NEW: To-Do List Container (hidden by default) -->
        <div id="todo-list-container" class="hidden"></div>
        <button id="add-todo-btn" class="hidden" onclick="addTodoItem()">+ Add Item</button>

        <!-- NEW: Editor stats with Word Count -->
        <div id="editor-stats">
            <div id="char-count">Character Count: 0</div>
            <div id="word-count">Word Count: 0</div>
        </div>
    </div>

    <!-- NEW: Whiteboard Feature -->
    <div id="whiteboard-container" class="hidden">
        <input type="text" id="whiteboard-title" placeholder="Your Whiteboard Title..." style="width: 100%; font-size: 20px; font-weight: 600; padding: 12px; border-radius: var(--radius); border: 1px solid #e0e0e0; margin-bottom: 15px;" />
        <canvas id="whiteboard-canvas"></canvas>
        <div id="whiteboard-toolbar">
            <label for="wb-color">Color:</label>
            <input type="color" id="wb-color" value="#000000">
            <label for="wb-size">Size:</label>
            <input type="range" id="wb-size" min="1" max="50" value="5">
            <button id="wb-eraser">Eraser</button>
            <button id="wb-clear">Clear</button>
            <button id="wb-download">Download PNG</button>
        </div>
    </div>


    <div id="notes">
        <h3><i class="fas fa-star" style="color: gold; margin-right: 8px;"></i>Your Saved Notes</h3>
        <div id="note-list"></div>
    </div>
   
    <!-- Informational sections remain the same -->
    <div class="info-section" id="overview">
        <h3>Overview</h3>
        <p>Note P@d is your smart, browser-based companion for everyday writing. Whether it's journaling, brainstorming, creating a to-do list, or drafting important content, this tool offers a fast, secure, and efficient note-taking experience without the need to install bulky software. Open it in your browser, and you're ready to go. It's lightweight, lightning-fast, and focused entirely on providing a seamless writing environment.</p>
    </div>
    <div class="info-section" id="how-it-works">
        <h3>How Does It Work?</h3>
        <p>Note P@d is built on modern web technologies to ensure your privacy and provide a smooth experience. All the notes you create are stored directly in your browser’s <code>localStorage</code>. This means your data never leaves your computer, and it’s not sent to any server. It works offline after the first visit, making it a reliable tool even without an internet connection. Key features like PDF export are handled by powerful JavaScript libraries right within your browser.</p>
    </div>
    <div class="info-section" id="about">
        <h3>About the Developer</h3>
        <div class="about-dev">
            <img src="https://i.ibb.co/Y4ygWpC2/Untitled-design.png" alt="Untitled-design" border="0">CEO ="Bishal Mishra">
            <div>
                <p>Note P@d is crafted with care by <strong><a href="https://www.facebook.com/share/166miohhL6/?mibextid=wwXIfr" target="_blank">Bishal Mishra</a></strong>, a passionate web developer dedicated to creating tools that are simple, powerful, and respect user privacy. This project is built to empower users with a fast, flexible, and secure writing experience. No fluff, just functionality that works for you.</p>
            </div>
        </div>
    </div>
    <div class="info-section" id="privacy">
        <h3>Privacy & Security</h3>
        <p>Your data is 100% yours, always. We believe in absolute privacy. All your notes are stored locally in your browser and are never transmitted to any external server. This means only you can access your content. Remember, clearing your browser's site data will permanently delete your notes, so be sure to use the export feature for important backups.</p>
    </div>
</main>

<!-- Modals and other elements remain the same -->
<div id="welcomePopup" class="welcome-popup hidden"> <div class="welcome-content"> <h2>Welcome to Note P@d!</h2> <p>Capture your ideas. Organize your thoughts. Let’s get started!</p> <button id="getStartedBtn">Get Started</button> </div> </div>
<div id="authModal" class="modal hidden"> <div class="modal-content"> <h2 id="authTitle">Sign In to Note P@d</h2> <input type="text" id="authUsername" placeholder="Username" /> <input type="password" id="authPassword" placeholder="Password" /> <button id="authSubmit">Sign In</button> <div id="googleSignInDiv" style="margin: 20px auto 0; display: flex; justify-content: center;"></div> <a href="#" id="forgotPassword">Forgot Password?</a> <p id="switchMode">Don't have an account? <a href="#">Sign Up</a></p> </div> </div>
<div id="find-replace-dialog" class="hidden"> <input type="text" id="find-input" placeholder="Find..."> <input type="text" id="replace-input" placeholder="Replace with..."> <button id="replace-btn">Replace</button> <button id="replace-all-btn">Replace All</button> <button id="close-find-replace" class="close-btn" title="Close">×</button> </div>
<button id="goToTopBtn" title="Go to top">↑</button>
<div id="confetti" class="confetti hidden">🎉</div>
<audio id="loginSound" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>

<footer>
    Design by ❤️ <a href="https://www.facebook.com/share/166miohhL6/?mibextid=wwXIfr" target="_blank">Bishal Mishra</a> | All Rights Reserved.
</footer>


<!-- SINGLE CONSOLIDATED SCRIPT -->
<script>
// --- GLOBAL VARIABLES ---
let editModeId = null;
let isSignUp = false;
let deferredInstallPrompt = null;
let undoStack = [];
let redoStack = [];
let lastChangeTimeout = null;
// NEW: Mode and Whiteboard state
let currentMode = 'notepad'; // 'notepad', 'whiteboard', or 'todo'
let whiteboardState = {
    canvas: null, ctx: null, isDrawing: false, isErasing: false,
    lastX: 0, lastY: 0, brushColor: '#000000', brushSize: 5
};

// --- DOM ELEMENTS ---
const titleInput = document.getElementById('note-title');
const textInput = document.getElementById('note-text');
const noteList = document.getElementById('note-list');
const charCount = document.getElementById('char-count');
const wordCount = document.getElementById('word-count'); // NEW
const installBtn = document.getElementById('installBtn');

// NEW: Mode-specific DOM elements
const editorSection = document.getElementById('editor');
const whiteboardSection = document.getElementById('whiteboard-container');
const todoListContainer = document.getElementById('todo-list-container');
const addTodoBtn = document.getElementById('add-todo-btn');
const whiteboardCanvas = document.getElementById('whiteboard-canvas');
const whiteboardTitleInput = document.getElementById('whiteboard-title');

const findReplaceDialog = document.getElementById('find-replace-dialog');

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    // Other initializations...
    loadDarkMode();
    checkAuthStatus();
    attachEventListeners();
    // NEW: Initialize features
    initWhiteboard(); 
    switchMode('notepad'); // Start in notepad mode
});

window.onload = initGoogleSignIn;

// --- FEATURE INITIALIZATION & EVENT LISTENERS ---
function attachEventListeners() {
    textInput.addEventListener('input', () => { updateAll(); recordState(); });
    titleInput.addEventListener('input', saveDraft);
    window.onscroll = () => { goToTopBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "block" : "none"; };
    goToTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
    // Other event listeners from original code...
    getStartedBtn.onclick = () => { welcomePopup.classList.add("hidden"); authModal.classList.remove("hidden"); localStorage.setItem("visited", "true"); }; switchMode.onclick = (e) => { e.preventDefault(); isSignUp = !isSignUp; authTitle.textContent = isSignUp ? "Create your Account" : "Welcome Back"; authSubmit.textContent = isSignUp ? "Sign Up" : "Sign In"; switchMode.innerHTML = isSignUp ? 'Already have an account? <a href="#">Sign In</a>' : 'Don’t have an account? <a href="#">Sign Up</a>'; }; authSubmit.onclick = handleAuthSubmit; logoutBtn.onclick = handleLogout; document.getElementById('close-find-replace').onclick = closeFindReplace; document.getElementById('replace-btn').onclick = () => findAndReplace(false); document.getElementById('replace-all-btn').onclick = () => findAndReplace(true);
}

// --- NEW: MODE SWITCHING ---
function switchMode(mode) {
    currentMode = mode;
    // Hide all main containers first
    editorSection.classList.add('hidden');
    whiteboardSection.classList.add('hidden');
    // Hide editor sub-components
    textInput.classList.add('hidden');
    todoListContainer.classList.add('hidden');
    addTodoBtn.classList.add('hidden');

    // Reset active button styles
    document.querySelectorAll('.mode-switcher button').forEach(b => b.classList.remove('active-mode'));

    if (mode === 'notepad') {
        editorSection.classList.remove('hidden');
        textInput.classList.remove('hidden');
        document.getElementById('mode-notepad').classList.add('active-mode');
    } else if (mode === 'whiteboard') {
        whiteboardSection.classList.remove('hidden');
        document.getElementById('mode-whiteboard').classList.add('active-mode');
        resizeWhiteboard();
    } else if (mode === 'todo') {
        editorSection.classList.remove('hidden');
        todoListContainer.classList.remove('hidden');
        addTodoBtn.classList.remove('hidden');
        document.getElementById('mode-todo').classList.add('active-mode');
    }
    // Make sure title inputs are managed correctly
    titleInput.classList.toggle('hidden', mode === 'whiteboard');
    whiteboardTitleInput.classList.toggle('hidden', mode !== 'whiteboard');
}

// --- NEW: WHITEBOARD FEATURE ---
function initWhiteboard() {
    whiteboardState.canvas = whiteboardCanvas;
    whiteboardState.ctx = whiteboardCanvas.getContext('2d');
    
    // Set initial canvas size
    resizeWhiteboard();
    
    // Event Listeners
    whiteboardState.canvas.addEventListener('mousedown', startDrawing);
    whiteboardState.canvas.addEventListener('mouseup', stopDrawing);
    whiteboardState.canvas.addEventListener('mouseout', stopDrawing);
    whiteboardState.canvas.addEventListener('mousemove', draw);
    // Touch events for mobile
    whiteboardState.canvas.addEventListener('touchstart', startDrawing);
    whiteboardState.canvas.addEventListener('touchend', stopDrawing);
    whiteboardState.canvas.addEventListener('touchmove', draw);

    document.getElementById('wb-color').onchange = (e) => { whiteboardState.brushColor = e.target.value; whiteboardState.isErasing = false; document.getElementById('wb-eraser').classList.remove('active'); };
    document.getElementById('wb-size').onchange = (e) => whiteboardState.brushSize = e.target.value;
    document.getElementById('wb-eraser').onclick = toggleEraser;
    document.getElementById('wb-clear').onclick = clearCanvas;
    document.getElementById('wb-download').onclick = downloadCanvas;
    window.addEventListener('resize', resizeWhiteboard);
}
function resizeWhiteboard() {
    const containerWidth = whiteboardSection.clientWidth - 50; // 25px padding on each side
    whiteboardState.canvas.width = containerWidth;
    whiteboardState.canvas.height = containerWidth * 0.6; // Maintain aspect ratio
    // Redraw content if any exists (e.g. on orientation change)
    if(whiteboardState.imageData) {
        whiteboardState.ctx.putImageData(whiteboardState.imageData, 0, 0);
    }
}
function getMousePos(e) {
    const rect = whiteboardState.canvas.getBoundingClientRect();
    const scaleX = whiteboardState.canvas.width / rect.width;
    const scaleY = whiteboardState.canvas.height / rect.height;
    if (e.touches && e.touches.length > 0) {
        return {
            x: (e.touches[0].clientX - rect.left) * scaleX,
            y: (e.touches[0].clientY - rect.top) * scaleY
        };
    }
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}
function startDrawing(e) {
    e.preventDefault();
    whiteboardState.isDrawing = true;
    const { x, y } = getMousePos(e);
    [whiteboardState.lastX, whiteboardState.lastY] = [x, y];
}
function stopDrawing() {
    if (!whiteboardState.isDrawing) return;
    whiteboardState.isDrawing = false;
    // Store current image data for redraw on resize
    whiteboardState.imageData = whiteboardState.ctx.getImageData(0, 0, whiteboardState.canvas.width, whiteboardState.canvas.height);
}
function draw(e) {
    e.preventDefault();
    if (!whiteboardState.isDrawing) return;
    const { ctx, lastX, lastY, brushColor, brushSize, isErasing } = whiteboardState;
    const { x, y } = getMousePos(e);

    ctx.globalCompositeOperation = isErasing ? 'destination-out' : 'source-over';
    ctx.strokeStyle = brushColor;
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();

    [whiteboardState.lastX, whiteboardState.lastY] = [x, y];
}
function toggleEraser() {
    whiteboardState.isErasing = !whiteboardState.isErasing;
    document.getElementById('wb-eraser').classList.toggle('active', whiteboardState.isErasing);
}
function clearCanvas() {
    whiteboardState.ctx.clearRect(0, 0, whiteboardState.canvas.width, whiteboardState.canvas.height);
    whiteboardState.imageData = null;
}
function downloadCanvas() {
    const link = document.createElement('a');
    link.download = `${whiteboardTitleInput.value || 'whiteboard'}.png`;
    link.href = whiteboardState.canvas.toDataURL('image/png');
    link.click();
}

// --- NEW: TO-DO LIST FEATURE ---
function addTodoItem(text = '', checked = false) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'todo-item';
    if (checked) itemDiv.classList.add('completed');

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = checked;
    checkbox.onchange = () => itemDiv.classList.toggle('completed', checkbox.checked);

    const textSpan = document.createElement('span');
    textSpan.className = 'todo-text';
    textSpan.contentEditable = true;
    textSpan.textContent = text || 'New to-do...';
    
    itemDiv.appendChild(checkbox);
    itemDiv.appendChild(textSpan);
    todoListContainer.appendChild(itemDiv);
}
function serializeTodoList() {
    const items = [];
    todoListContainer.querySelectorAll('.todo-item').forEach(item => {
        const text = item.querySelector('.todo-text').textContent;
        const checked = item.querySelector('input[type="checkbox"]').checked;
        items.push({ text, checked });
    });
    return JSON.stringify(items);
}
function parseAndRenderTodoList(jsonString) {
    todoListContainer.innerHTML = ''; // Clear existing
    try {
        const items = JSON.parse(jsonString);
        items.forEach(item => addTodoItem(item.text, item.checked));
    } catch (e) {
        console.error("Failed to parse To-Do list", e);
        todoListContainer.innerHTML = '<p>Error loading to-do list.</p>';
    }
}

// --- CORE FUNCTIONS (MODIFIED FOR NEW FEATURES) ---
function newDoc() {
    editModeId = null;
    titleInput.value = '';
    textInput.value = '';
    whiteboardTitleInput.value = ''; // NEW
    todoListContainer.innerHTML = ''; // NEW
    clearCanvas(); // NEW
    updateAll();
    clearDraft();
    resetHistory();
    switchMode('notepad'); // NEW
    titleInput.focus();
}

function saveNote() {
    const key = getUserNotesKey();
    if (!key) { alert("Please sign in to save notes."); return; }

    let title, content, type;
    if (currentMode === 'notepad') {
        if (!textInput.value.trim()) { alert("Cannot save an empty note."); return; }
        title = titleInput.value || 'Untitled Note';
        content = textInput.value;
        type = 'notepad';
    } else if (currentMode === 'whiteboard') {
        title = whiteboardTitleInput.value || 'Untitled Whiteboard';
        content = whiteboardState.canvas.toDataURL(); // Save as base64 image
        type = 'whiteboard';
    } else if (currentMode === 'todo') {
        if (todoListContainer.children.length === 0) { alert("Cannot save an empty to-do list."); return; }
        title = titleInput.value || 'Untitled To-Do List';
        content = serializeTodoList();
        type = 'todo';
    }

    const notes = JSON.parse(localStorage.getItem(key)) || [];
    const timestamp = new Date().toLocaleString();
    if (editModeId) {
        const idx = notes.findIndex(n => n.id === editModeId);
        if (idx > -1) {
            notes[idx] = { ...notes[idx], title, text: content, type, date: timestamp }; 
        }
    } else {
        notes.unshift({ id: Date.now(), title, text: content, type, date: timestamp, pinned: false, isLocked: false });
    }
    localStorage.setItem(key, JSON.stringify(notes));
    displayNotes();
    newDoc();
}

function displayNotes() {
    const key = getUserNotesKey();
    const notes = key ? JSON.parse(localStorage.getItem(key)) || [] : [];
    notes.sort((a, b) => b.pinned - a.pinned || b.id - a.id);
    
    noteList.innerHTML = notes.map(n => {
        let contentPreview = '';
        const noteType = n.type || 'notepad'; // Default to notepad for old notes
        if (n.isLocked) {
            contentPreview = `<i>This note is locked.</i>`;
        } else if (noteType === 'whiteboard') {
            contentPreview = `<img src="${n.text}" alt="Whiteboard Preview" style="width:100%; height:auto; border-radius: 8px; margin-top: 10px;">`;
        } else if (noteType === 'todo') {
            contentPreview = `<i>To-Do List with ${JSON.parse(n.text).length} items.</i>`;
        } else {
            contentPreview = `${n.text.substring(0, 200)}${n.text.length > 200 ? '...' : ''}`;
        }

        return `
        <div class="note ${n.pinned ? 'pinned' : ''}" id="note-${n.id}">
            <h4>
                ${noteType === 'whiteboard' ? '🎨' : (noteType === 'todo' ? '☑️' : '📝')} 
                ${n.title} 
                ${n.isLocked ? '<i class="fas fa-lock" style="color: #ffc107;"></i>' : ''}
            </h4>
            <p>${contentPreview}</p>
            <small>Last updated: ${n.date}</small>
            <div class="note-actions">
                <button onclick="editNote(${n.id})"><i class="fas fa-edit"></i> Edit</button>
                <button onclick="toggleLock(${n.id})"><i class="fas fa-key"></i> ${n.isLocked ? 'Unlock' : 'Lock'}</button>
                <button onclick="pinNote(${n.id})"><i class="fas fa-thumbtack"></i> ${n.pinned ? 'Unpin' : 'Pin'}</button>
                ${noteType !== 'whiteboard' ? `<button onclick="exportPDF(${n.id})"><i class="fas fa-file-pdf"></i> PDF</button>` : ''}
                <button onclick="deleteNote(${n.id})"><i class="fas fa-trash"></i> Delete</button>
            </div>
        </div>
    `}).join('');
}

async function editNote(id) {
    const key = getUserNotesKey(); if (!key) return;
    const notes = JSON.parse(localStorage.getItem(key)) || [];
    const note = notes.find(n => n.id === id);
    if (!note) return;
    if (note.isLocked) { /* ... existing lock logic ... */ }

    newDoc(); // Clear everything first
    const noteType = note.type || 'notepad';
    switchMode(noteType);
    editModeId = id;

    if (noteType === 'notepad') {
        titleInput.value = note.title;
        textInput.value = note.text;
        resetHistory(note.text);
    } else if (noteType === 'whiteboard') {
        whiteboardTitleInput.value = note.title;
        const img = new Image();
        img.onload = () => {
            clearCanvas();
            whiteboardState.ctx.drawImage(img, 0, 0);
            whiteboardState.imageData = whiteboardState.ctx.getImageData(0, 0, whiteboardState.canvas.width, whiteboardState.canvas.height);
        };
        img.src = note.text;
    } else if (noteType === 'todo') {
        titleInput.value = note.title;
        parseAndRenderTodoList(note.text);
    }
    
    updateAll();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateCharCount() { charCount.textContent = `Character Count: ${textInput.value.length}`; }
function updateWordCount() { // NEW
    const words = textInput.value.trim().split(/\s+/).filter(word => word.length > 0);
    wordCount.textContent = `Word Count: ${words.length}`;
}
function updateAll() { saveDraft(); updateCharCount(); updateWordCount(); }
function saveDraft() {
    const key = getDraftKey(); if (!key) return;
    // Draft saving is complex with modes, so we simplify to only save notepad drafts for now.
    if (currentMode === 'notepad') {
        localStorage.setItem(key, JSON.stringify({ title: titleInput.value, text: textInput.value }));
    }
}
function loadDraft() { 
    const key = getDraftKey(); if (!key) return;
    const d = localStorage.getItem(key); 
    if (d) { const { title, text } = JSON.parse(d); titleInput.value = title; textInput.value = text; } 
}

// ... All other functions (auth, helpers, etc.) from the previous script remain here ...
// They are mostly unchanged and are omitted here for brevity but should be included in your final script tag.
// For example: getCurrentUserId, getUserNotesKey, hashPassword, history functions, cutText, find/replace,
// deleteNote, pinNote, toggleLock, exportPDF, clearDraft, UI/Theme functions, Auth functions, PWA, shortcuts.
// The below is a simplified placeholder for the rest of your existing JS.

function checkAuthStatus() { const currentUserId = getCurrentUserId(); if (currentUserId) { showUserInfo(localStorage.getItem("currentUser"), localStorage.getItem("userPic")); loadDraft(); displayNotes(); updateAll(); resetHistory(textInput.value); } else if (!localStorage.getItem("visited")) { welcomePopup.classList.remove("hidden"); } else { authModal.classList.remove("hidden"); } }
function handleAuthSubmit() { const username = authUsername.value.trim(); const password = authPassword.value.trim(); if (!username || !password) return alert("Please fill in all fields"); const users = JSON.parse(localStorage.getItem("users") || "{}"); if (isSignUp) { if (users[username]) return alert("Username already exists"); users[username] = password; localStorage.setItem("users", JSON.stringify(users)); localStorage.setItem("currentUser", username); loginSuccess(username, "", username); } else { if (users[username] !== password) return alert("Invalid credentials"); localStorage.setItem("currentUser", username); loginSuccess(username, "", username); } }
function handleLogout() { localStorage.removeItem("currentUser"); localStorage.removeItem("userPic"); localStorage.removeItem("currentUserId"); if (typeof google !== 'undefined') google.accounts.id.disableAutoSelect(); userInfo.style.display = "none"; authModal.classList.remove("hidden"); noteList.innerHTML = ''; newDoc(); }
function getCurrentUserId() { return localStorage.getItem('currentUserId'); }
function getUserNotesKey() { const userId = getCurrentUserId(); return userId ? `notes_${userId}` : null; }
function getDraftKey() { const userId = getCurrentUserId(); return userId ? `draft_${userId}` : null; }
function loginSuccess(username, picUrl, userId) { localStorage.setItem("currentUserId", userId); showUserInfo(username, picUrl); authModal.classList.add("hidden"); confetti.classList.remove("hidden"); loginSound.play().catch(e => console.log("Audio play failed:", e)); setTimeout(() => confetti.classList.add("hidden"), 1200); loadDraft(); displayNotes(); updateAll(); resetHistory(textInput.value); }
function showUserInfo(username, picUrl) { userInfo.style.display = "flex"; userNameDisplay.textContent = username; userPic.src = picUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=random`; }
function initGoogleSignIn() { try { google.accounts.id.initialize({ client_id: "107788525119-7mkm9t2pqe53q85ltenn4lr3av7itdfh.apps.googleusercontent.com", callback: handleGoogleSignIn }); google.accounts.id.renderButton( document.getElementById("googleSignInDiv"), { theme: "outline", size: "large", shape: "pill", width: "300" } ); } catch (error) { console.error("Google GSI could not be initialized.", error); document.getElementById('googleSignInDiv').innerHTML = "Google Sign-In failed to load."; } }
function jwtDecode(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
function handleGoogleSignIn(response) { const data = jwtDecode(response.credential); if (!data) return; const name = data.name || data.email; const picture = data.picture || ""; const userId = data.sub; localStorage.setItem("currentUser", name); localStorage.setItem("userPic", picture); loginSuccess(name, picture, userId); }
async function hashPassword(password) { if (!password) return ''; const encoder = new TextEncoder(); const data = encoder.encode(password); const hashBuffer = await crypto.subtle.digest('SHA-256', data); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); }
function recordState() { clearTimeout(lastChangeTimeout); lastChangeTimeout = setTimeout(() => { if (currentMode !== 'notepad') return; const currentState = textInput.value; if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentState) { undoStack.push(currentState); redoStack = []; if (undoStack.length > 50) undoStack.shift(); } }, 500); }
function undo() { if (currentMode !== 'notepad' || undoStack.length < 2) return; const currentState = undoStack.pop(); redoStack.push(currentState); textInput.value = undoStack[undoStack.length - 1]; updateAll(); }
function redo() { if (currentMode !== 'notepad' || redoStack.length === 0) return; const nextState = redoStack.pop(); undoStack.push(nextState); textInput.value = nextState; updateAll(); }
function resetHistory(initialText = '') { undoStack = [initialText]; redoStack = []; }
function cutText() { if (currentMode !== 'notepad') return; const start = textInput.selectionStart; const end = textInput.selectionEnd; if (start === end) return; const selectedText = textInput.value.substring(start, end); navigator.clipboard.writeText(selectedText).then(() => { textInput.value = textInput.value.substring(0, start) + textInput.value.substring(end); textInput.focus(); textInput.setSelectionRange(start, start); updateAll(); recordState(); }); }
function showFindReplace() { if (currentMode !== 'notepad') return; findReplaceDialog.classList.remove('hidden'); findInput.focus(); }
function closeFindReplace() { findReplaceDialog.classList.add('hidden'); }
function findAndReplace(replaceAll = false) { const findValue = findInput.value; const replaceValue = replaceInput.value; if (!findValue) return; if (replaceAll) { textInput.value = textInput.value.replace(new RegExp(findValue, 'g'), replaceValue); } else { textInput.value = textInput.value.replace(findValue, replaceValue); } updateAll(); recordState(); }
function deleteNote(id) { const key = getUserNotesKey(); if (!key) return; if (!confirm("Are you sure you want to delete this note permanently?")) return; let notes = JSON.parse(localStorage.getItem(key)) || []; localStorage.setItem(key, JSON.stringify(notes.filter(n => n.id !== id))); displayNotes(); if (editModeId === id) newDoc(); }
function pinNote(id) { const key = getUserNotesKey(); if (!key) return; const notes = JSON.parse(localStorage.getItem(key)) || []; const note = notes.find(n => n.id === id); if (note) { note.pinned = !note.pinned; } localStorage.setItem(key, JSON.stringify(notes)); displayNotes(); }
async function toggleLock(id) { const key = getUserNotesKey(); if (!key) return; let notes = JSON.parse(localStorage.getItem(key)) || []; const noteIndex = notes.findIndex(n => n.id === id); if (noteIndex === -1) return; const note = notes[noteIndex]; if (note.isLocked) { const password = prompt("Enter password to unlock this note:"); if (!password) return; const hashed = await hashPassword(password); if (hashed === note.passwordHash) { note.isLocked = false; delete note.passwordHash; alert("Note unlocked!"); } else { alert("Incorrect password."); return; } } else { const password = prompt("Enter a new password to lock this note (min 4 chars):"); if (!password || password.length < 4) { alert("Password is too short."); return; } const confirmPassword = prompt("Confirm password:"); if (password !== confirmPassword) { alert("Passwords do not match."); return; } note.isLocked = true; note.passwordHash = await hashPassword(password); alert("Note locked successfully!"); } notes[noteIndex] = note; localStorage.setItem(key, JSON.stringify(notes)); displayNotes(); }
async function exportPDF(id) { const key = getUserNotesKey(); if (!key) return; const notes = JSON.parse(localStorage.getItem(key)) || []; const note = notes.find(n => n.id === id); if (!note) return; if (note.isLocked) { const password = prompt("This note is locked. Enter password to export:"); if (!password) return; const hashed = await hashPassword(password); if (hashed !== note.passwordHash) { alert("Incorrect password."); return; } } const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFont("Helvetica", "bold"); doc.setFontSize(20); doc.text(note.title, 15, 20); doc.setFont("Helvetica", "normal"); doc.setFontSize(12); let contentToExport = note.text; if (note.type === 'todo') { const todoItems = JSON.parse(note.text); contentToExport = todoItems.map(item => `${item.checked ? '[x]' : '[ ]'} ${item.text}`).join('\n'); } doc.text(doc.splitTextToSize(contentToExport, 180), 15, 30); doc.save(`${note.title.replace(/\s+/g, '_')}.pdf`); }
function clearDraft() { const key = getDraftKey(); if (key) localStorage.removeItem(key); }
function toggleDark() { document.body.classList.toggle('dark'); localStorage.setItem('darkMode', document.body.classList.contains('dark')); }
function loadDarkMode() { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); }
function changeFont() { textInput.style.fontFamily = document.getElementById('font-family').value; }
function changeFontSize() { textInput.style.fontSize = document.getElementById('font-size').value; }
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredInstallPrompt = e; installBtn.classList.remove('hidden'); });
installBtn.addEventListener('click', async () => { if (deferredInstallPrompt) { deferredInstallPrompt.prompt(); await deferredInstallPrompt.userChoice; deferredInstallPrompt = null; installBtn.classList.add('hidden'); } });
document.addEventListener('keydown', (e) => { if (e.ctrlKey) { switch (e.key.toLowerCase()) { case 's': e.preventDefault(); saveNote(); break; case 'n': e.preventDefault(); newDoc(); break; case 'z': e.preventDefault(); undo(); break; case 'y': e.preventDefault(); redo(); break; } } });

</script>

</body>
</html>
